name: Daily Playwright Tests

on:
  schedule:
    # Run daily at 9:00 AM UTC (10:00 AM in Lisbon)
    - cron: '0 9 * * *'
  # Allow manual trigger
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Install Playwright browsers
      run: npx playwright install --with-deps
      
    - name: Run Playwright tests
      run: |
        echo "ðŸŽ­ Starting Playwright Tests..."
        echo "ðŸ“… Date: $(date)"
        echo "ðŸŒ Testing site: https://sets.antoniocoutinho.pt/"
        echo "ðŸ“Š Running tests on multiple browsers..."
        echo ""
        npm test
      continue-on-error: true
      
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-report-${{ github.run_number }}
        path: |
          playwright-report/
          test-results/
        retention-days: 7
        
    - name: Generate test summary
      if: always()
      run: |
        echo "ðŸŽ­ Generating test summary..."
        echo ""
        
        echo "## ðŸŽ­ RelatÃ³rio de Testes - Sets AntÃ³nio Coutinho" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**ðŸ“… Data:** $(date '+%d/%m/%Y Ã s %H:%M')" >> $GITHUB_STEP_SUMMARY
        echo "**ðŸŒ Site testado:** [sets.antoniocoutinho.pt](https://sets.antoniocoutinho.pt/)" >> $GITHUB_STEP_SUMMARY
        echo "**ðŸ”„ ExecuÃ§Ã£o:** #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Check if tests passed/failed and add status
        if [ -f "playwright-report/index.html" ]; then
          echo "### âœ… Testes Executados com Sucesso" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸ§ª O que foi testado:**" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **Funcionamento bÃ¡sico** - Carregamento da pÃ¡gina, elementos visÃ­veis" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŽµ **Player de Ã¡udio** - ReproduÃ§Ã£o de mÃºsica, controlos" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“± **Downloads** - BotÃµes de download, nomes de ficheiros" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“‹ **Playlist** - Mostrar/esconder lista de reproduÃ§Ã£o" >> $GITHUB_STEP_SUMMARY
          echo "- â™¿ **Acessibilidade** - NavegaÃ§Ã£o por teclado, estrutura da pÃ¡gina" >> $GITHUB_STEP_SUMMARY
          echo "- âš¡ **Performance** - Velocidade de carregamento, memoria" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“± **Mobile** - Funcionamento em dispositivos mÃ³veis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸ“Š Browsers testados:**" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŒ **Chrome** (Desktop) - Navegador principal" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ¦Š **Firefox** (Desktop) - Compatibilidade Mozilla" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ§­ **Safari** (Desktop) - Compatibilidade Apple" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“± **Chrome Mobile** - Android/dispositivos mÃ³veis" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“± **Safari Mobile** - iPhone/iPad" >> $GITHUB_STEP_SUMMARY
        else
          echo "### âŒ Problemas na ExecuÃ§Ã£o dos Testes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Os testes podem ter falhado ou nÃ£o ter terminado correctamente." >> $GITHUB_STEP_SUMMARY
          echo "Verifica os logs acima para mais detalhes." >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”— Links Ãšteis" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“„ **[Ver RelatÃ³rio Completo](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts)** - Download dos relatÃ³rios HTML detalhados" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸŒ **[Visitar Website](https://sets.antoniocoutinho.pt/)** - Ver o site testado" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ”„ **[Executar Testes Novamente](https://github.com/${{ github.repository }}/actions/workflows/daily-tests.yml)** - Correr manualmente" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**ðŸ’¡ Nota:** Os relatÃ³rios sÃ£o guardados por 7 dias e depois apagados automaticamente." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "*RelatÃ³rio gerado automaticamente* ðŸ¤–" >> $GITHUB_STEP_SUMMARY
        
        echo "âœ… Test summary generated successfully"