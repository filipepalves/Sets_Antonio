name: Daily Playwright Tests

on:
  schedule:
    # Run daily at 9:00 AM UTC (10:00 AM in Lisbon)
    - cron: '0 9 * * *'
  # Allow manual trigger
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Install Playwright browsers
      run: npx playwright install --with-deps
      
    - name: Run Playwright tests
      run: npm test
      continue-on-error: true
      
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-report-${{ github.run_number }}
        path: |
          playwright-report/
          test-results/
        retention-days: 30
        
    - name: Generate test summary
      if: always()
      run: |
        echo "## ğŸ­ Playwright Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**ğŸ“… Date:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "**ğŸŒ Site:** [sets.antoniocoutinho.pt](https://sets.antoniocoutinho.pt/)" >> $GITHUB_STEP_SUMMARY
        echo "**ğŸ“ Repository:** [${{ github.repository }}](https://github.com/${{ github.repository }})" >> $GITHUB_STEP_SUMMARY
        echo "**ğŸ”„ Run ID:** ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Check if tests passed/failed and add status
        if [ -f "playwright-report/index.html" ]; then
          echo "### âœ… Test Report Generated Successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Test Coverage:**" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Basic functionality tests" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸµ Audio player functionality" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“± Download functionality" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“‹ Playlist functionality" >> $GITHUB_STEP_SUMMARY
          echo "- â™¿ Accessibility tests" >> $GITHUB_STEP_SUMMARY
          echo "- âš¡ Performance tests" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“± Mobile responsiveness" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ğŸ“Š Browsers Tested:**" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸŒ Chrome (Desktop)" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ¦Š Firefox (Desktop)" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ§­ Safari (Desktop)" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“± Chrome Mobile" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“± Safari Mobile" >> $GITHUB_STEP_SUMMARY
        else
          echo "### âŒ No test report found" >> $GITHUB_STEP_SUMMARY
          echo "Tests may have failed to complete." >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ”— Useful Links" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ“„ [Download Full Report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ“¦ [View Artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts)" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸŒ [Visit Website](https://sets.antoniocoutinho.pt/)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "*Generated automatically by GitHub Actions* ğŸ¤–" >> $GITHUB_STEP_SUMMARY
        
    - name: Send email notification
      if: always()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "ğŸ­ Daily Tests - Sets AntÃ³nio Coutinho"
        to: ${{ secrets.EMAIL_TO }}
        from: ${{ secrets.EMAIL_USERNAME }}
        html_body: |
          <h2>ğŸ­ Daily Test Notification</h2>
          <p><strong>ğŸ“… Date:</strong> $(date)</p>
          <p><strong>ğŸŒ Site:</strong> <a href="https://sets.antoniocoutinho.pt/">sets.antoniocoutinho.pt</a></p>
          
          <h3>ğŸ“Š Quick Summary</h3>
          <p>Daily automated tests have been executed.</p>
          
          <h3>ğŸ”— View Results</h3>
          <ul>
            <li><a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}">ğŸ“„ View Full Report & Summary</a></li>
            <li><a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts">ğŸ“¦ Download Detailed Reports</a></li>
          </ul>
          
          <p><em>This is an automated message from GitHub Actions.</em></p>